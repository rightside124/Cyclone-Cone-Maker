<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mxtthew's ConeGen</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&family=Montserrat:wght@700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6;
            --bg: #000000;
            --panel: #0a0a0c;
            --border: #1f1f23;
            --card: #0d0d0f;
            --input-bg: #000;
            --text-dim: #71717a;
            --sidebar-width: 380px;
            --radius: 10px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }

        /* Sidebar Layout */
        .sidebar {
            width: var(--sidebar-width); min-width: var(--sidebar-width);
            background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 50;
        }
        .sidebar-header { 
            padding: 16px 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .sidebar-header h1 { font-size: 10px; margin: 0; text-transform: uppercase; letter-spacing: 2px; color: #fff; font-weight: 700; }
        
        .tabs { display: flex; padding: 4px; background: #000; margin: 16px; border-radius: var(--radius); border: 1px solid var(--border); }
        .tab { 
            flex: 1; padding: 8px; font-size: 9px; text-transform: uppercase; letter-spacing: 1px;
            text-align: center; cursor: pointer; color: var(--text-dim); transition: 0.2s;
            border-radius: 6px; font-weight: 700;
        }
        .tab.active { color: #fff; background: #1c1c1f; }

        .tab-content { flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; display: none; }
        .tab-content.active { display: block; }
        
        .section-label { font-size: 9px; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1.5px; display: block; margin: 24px 0 12px 0; font-weight: 700; }

        /* Controls Style */
        .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .slider-label { font-size: 11px; width: 100px; color: #fff; }
        input[type="range"] {
            -webkit-appearance: none; flex: 1; height: 6px; background: #1f1f23; border-radius: 10px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; background: #fff; cursor: pointer; border-radius: 50%;
            border: 2px solid var(--accent); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        /* Checkbox Fixes */
        input[type="checkbox"] {
            -webkit-appearance: none;
            width: 18px; height: 18px; border: 1px solid var(--border);
            border-radius: 4px; background: #000; cursor: pointer; position: relative;
            flex-shrink: 0;
        }
        input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
        input[type="checkbox"]:checked::after {
            content: 'âœ“'; color: white; position: absolute; font-size: 11px; font-weight: 900;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }

        input, select {
            background: var(--input-bg); border: 1px solid var(--border); color: #fff;
            padding: 8px 10px; border-radius: 8px; font-size: 12px; width: 100%; transition: 0.2s;
        }
        input:focus { border-color: var(--accent); outline: none; }

        /* Point Cards */
        .point-card {
            background: var(--card); border: 1px solid var(--border);
            padding: 12px; border-radius: 10px; margin-bottom: 8px;
            transition: border-color 0.3s;
            cursor: pointer;
        }
        .point-card.highlighted {
            border-color: var(--accent);
            background: #0f172a;
        }
        .card-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; }
        .point-id { font-size: 10px; font-weight: 800; color: #3b82f6; width: 22px; pointer-events: none; }
        
        /* Viewport & Canvas */
        .viewport { 
            flex: 1; position: relative; background: #050507; overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
        }
        canvas { display: block; cursor: crosshair; }

        .legend {
            position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8);
            padding: 14px; border-radius: 12px; border: 1px solid var(--border); backdrop-filter: blur(10px);
            z-index: 10; font-size: 9px; pointer-events: none;
        }
        .leg-item { display: flex; align-items: center; margin-bottom: 4px; gap: 8px; color: #aaa; text-transform: uppercase; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Buttons */
        .btn {
            background: var(--accent); color: white; border: none; padding: 10px;
            border-radius: 10px; cursor: pointer; font-size: 10px; font-weight: 700; transition: 0.2s;
            text-transform: uppercase; letter-spacing: 1px; width: 100%;
        }
        .btn-secondary { background: #1c1c1f; color: #fff; border: 1px solid var(--border); margin-bottom: 8px; }
        .btn-danger { background: #1a0b0b; color: #ff5555; border: 1px solid rgba(255,85,85,0.2); margin-top: 10px; }

        .pill-toggle { display: flex; background: #000; border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .pill { 
            flex: 1; border: none; background: none; color: var(--text-dim); font-size: 9px; 
            padding: 6px; cursor: pointer; border-radius: 6px; font-weight: 700; transition: 0.2s;
        }
        .pill.active { background: #3b82f6; color: white; }

        #basemapAdjustments {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #000;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h1>mxttchew's ConeGen !</h1>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-secondary" style="width:auto; padding:4px 8px; margin:0; font-size:9px; border-radius:8px;" onclick="undo()">Undo</button>
                <button class="btn btn-secondary" style="width:auto; padding:4px 8px; margin:0; font-size:9px; border-radius:8px;" onclick="redo()">Redo</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('controls')">Settings</div>
            <div class="tab" onclick="switchTab('points')">Track</div>
        </div>
        
        <div id="controls" class="tab-content active">
            <span class="section-label">Unit & Time Settings</span>
            <div class="pill-toggle">
                <button class="pill active" id="unit-mph" onclick="setUnit('mph')">MPH</button>
                <button class="pill" id="unit-kph" onclick="setUnit('kph')">KPH</button>
                <button class="pill" id="unit-kt" onclick="setUnit('kt')">KT</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:12px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="showMultiUnit" onchange="draw()">
                    <span style="font-size:11px; color:var(--text-dim)">Show Dual Units</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:11px; color:var(--text-dim)">Interval (Hrs):</span>
                    <input type="number" id="timeInterval" value="6" style="width:60px; padding:4px;" onchange="cascadeDateTime()">
                </div>
            </div>

            <span class="section-label">Visual Style</span>
            <div class="slider-row">
                <span class="slider-label">Font Family</span>
                <select id="fontFamily" onchange="handleFontChange()">
                    <option value="Inter">Inter (Clean)</option>
                    <option value="Roboto Mono">Roboto Mono (Tech)</option>
                    <option value="Montserrat">Montserrat (Bold)</option>
                    <option value="Oswald">Oswald (Narrow)</option>
                    <option value="Arial">Arial (Classic)</option>
                    <option value="custom">Other / Local Font...</option>
                </select>
            </div>
            <div id="customFontContainer" class="slider-row" style="display:none">
                <span class="slider-label">Font Name</span>
                <input type="text" id="customFontName" placeholder="e.g. Helvetica" oninput="draw()">
            </div>
            <div class="slider-row">
                <span class="slider-label">Point Size</span>
                <input type="range" id="pointSize" min="4" max="22" value="9">
            </div>
            <div class="slider-row">
                <span class="slider-label">Text Size</span>
                <input type="range" id="textSize" min="8" max="24" value="11">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px">
                <div style="display:flex; align-items:center; gap:8px">
                    <input type="checkbox" id="pointOutline" checked>
                    <span style="font-size:11px">Outlines</span>
                </div>
                <input type="color" id="outlineColor" value="#ffffff" style="width:40px; height:24px; padding:0; border:none; background:none;">
            </div>

            <span class="section-label">Basemap & Adjustment</span>
            <button class="btn btn-secondary" onclick="document.getElementById('imageLoader').click()">Upload Basemap</button>
            <input type="file" id="imageLoader" accept="image/*" style="display:none">
            
            <button class="btn btn-secondary" id="toggleAdjust" onclick="toggleBasemapControls()">Show Manual Controls</button>
            <div id="basemapAdjustments">
                <div class="slider-row">
                    <span class="slider-label">Img Scale</span>
                    <input type="range" id="mapScale" min="10" max="1000" value="100" oninput="draw()">
                </div>
                <div class="slider-row">
                    <span class="slider-label">Img X Offset</span>
                    <input type="range" id="mapX" min="-5000" max="5000" value="0" oninput="draw()">
                </div>
                <div class="slider-row">
                    <span class="slider-label">Img Y Offset</span>
                    <input type="range" id="mapY" min="-5000" max="5000" value="0" oninput="draw()">
                </div>
            </div>

            <span class="section-label">Cone Dynamics</span>
            <div class="slider-row">
                <input type="color" id="coneColor" value="#ffffff" style="width:40px; height:30px; padding:0; border:none; background:none;">
                <input type="range" id="coneOpacity" min="1" max="10" value="3">
            </div>
            <div class="slider-row">
                <span class="slider-label">Spread</span>
                <input type="range" id="coneGrowth" min="5" max="200" value="90">
            </div>

            <span class="section-label">Export</span>
            <div style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
                <input type="checkbox" id="includeLegend" checked>
                <span style="font-size:11px; color:var(--text-dim)">Include Legend in Export</span>
            </div>

            <button class="btn" style="background:#a5f3fc; color:#000" onclick="confirmExport()">Export PNG</button>
            <button class="btn btn-danger" onclick="resetPoints()">Wipe Track Points</button>
        </div>

        <div id="points" class="tab-content">
            <div id="pointList"></div>
        </div>
    </div>

    <div class="viewport">
        <canvas id="stormCanvas"></canvas>
        <div class="legend" id="legend"></div>
    </div>

<script>
    const canvas = document.getElementById('stormCanvas');
    const ctx = canvas.getContext('2d');
    
    const SCHEME = [
        { label: "Cat 5", min: 157, color: "#A188FC" },
        { label: "Cat 4", min: 130, color: "#FF738A" },
        { label: "Cat 3", min: 111, color: "#FF9E59" },
        { label: "Cat 2", min: 96,  color: "#FFD98C" },
        { label: "Cat 1", min: 74,  color: "#FFFFD9" },
        { label: "TS / SS", min: 39, color: "#4DFFFF" },
        { label: "TD / SD", min: 1,  color: "#6EC1EA" },
        { label: "PT / EX", min: 0.5, color: "#1591DE" },
        { label: "RL / POST", min: 0, color: "#CCCCCC" }
    ];

    let points = [];
    let historyStack = [];
    let redoStack = [];
    let bgImage = null;
    let draggingPoint = null;
    let currentUnit = 'mph';
    let highlightedPointIndex = -1;

    let isMapDragging = false;
    let lastMousePos = { x: 0, y: 0 };

    function saveState() {
        historyStack.push(JSON.stringify(points));
        if (historyStack.length > 50) historyStack.shift();
        redoStack = [];
    }

    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(points));
            points = JSON.parse(historyStack.pop());
            updateSidebar();
            draw();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(points));
            points = JSON.parse(redoStack.pop());
            updateSidebar();
            draw();
        }
    }

    function toggleBasemapControls() {
        const div = document.getElementById('basemapAdjustments');
        const btn = document.getElementById('toggleAdjust');
        const isHidden = div.style.display !== 'block';
        div.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'Hide Manual Controls' : 'Show Manual Controls';
    }

    window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
        if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
    });

    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        draw();
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', resizeCanvas);

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function setUnit(unit) {
        saveState();
        const oldUnit = currentUnit;
        currentUnit = unit;
        points.forEach(p => p.wind = convertWind(p.wind, oldUnit, unit));
        updateSidebar();
        draw();
    }

    function convertWind(val, from, to) {
        if (!val) return 0;
        let mph;
        if (from === 'mph') mph = val;
        else if (from === 'kph') mph = val / 1.60934;
        else if (from === 'kt') mph = val * 1.15078;
        let result;
        if (to === 'mph') result = mph;
        else if (to === 'kph') result = mph * 1.60934;
        else if (to === 'kt') result = mph / 1.15078;
        return Math.round(result / 5) * 5;
    }

    function handleFontChange() {
        const sel = document.getElementById('fontFamily').value;
        document.getElementById('customFontContainer').style.display = sel === 'custom' ? 'flex' : 'none';
        draw();
    }

    function cascadeDateTime() {
        if (points.length < 1) return;
        saveState();
        const interval = parseFloat(document.getElementById('timeInterval').value) || 6;
        let p0 = points[0];
        
        // Base start point
        let startObj = (p0.date && p0.time) ? new Date(`${p0.date}T${p0.time}:00Z`) : new Date();
        
        for(let i = 1; i < points.length; i++) {
            // Force sequential forward movement using UTC to avoid DST or local glitches
            let nextDate = new Date(startObj.getTime() + (i * interval * 60 * 60 * 1000));
            points[i].date = nextDate.toISOString().split('T')[0];
            points[i].time = nextDate.toISOString().split('T')[1].slice(0,5);
        }
        updateSidebar();
        draw();
    }

    document.getElementById('imageLoader').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
                bgImage = new Image();
                bgImage.onload = () => {
                    document.getElementById('mapScale').value = 100;
                    document.getElementById('mapX').value = 0;
                    document.getElementById('mapY').value = 0;
                    draw();
                };
                bgImage.src = event.target.result;
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    function draw(isExport = false) {
        // Update Unit Pill Highlights
        const isDual = document.getElementById('showMultiUnit').checked;
        const secondUnit = (currentUnit === 'mph') ? 'kph' : (currentUnit === 'kph' ? 'kt' : 'mph');
        
        document.querySelectorAll('.pill').forEach(b => {
            const bUnit = b.id.replace('unit-', '');
            b.classList.remove('active');
            if (bUnit === currentUnit) b.classList.add('active');
            if (isDual && bUnit === secondUnit) b.classList.add('active');
        });

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (bgImage) {
            const scale = document.getElementById('mapScale').value / 100;
            const ox = parseInt(document.getElementById('mapX').value);
            const oy = parseInt(document.getElementById('mapY').value);
            const sw = bgImage.width * scale;
            const sh = bgImage.height * scale;
            ctx.drawImage(bgImage, (canvas.width/2 - sw/2) + ox, (canvas.height/2 - sh/2) + oy, sw, sh);
        } else {
            ctx.fillStyle = "#08080a"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = "rgba(255,255,255,0.02)";
            for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
            for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
        }
        if (points.length >= 2) renderCone();
        renderPoints();
        if (isExport && document.getElementById('includeLegend').checked) renderLegendToCanvas();
    }

    function renderCone() {
        const growth = parseInt(document.getElementById('coneGrowth').value);
        const opacity = document.getElementById('coneOpacity').value / 10;
        const tint = document.getElementById('coneColor').value;
        const upperSide = []; const lowerSide = [];
        for (let i = 0; i < points.length; i++) {
            let r = (i / (points.length - 1)) * growth;
            let angle = getPerpAngle(i);
            upperSide.push({ x: points[i].x + Math.cos(angle - Math.PI / 2) * r, y: points[i].y + Math.sin(angle - Math.PI / 2) * r });
            lowerSide.push({ x: points[i].x + Math.cos(angle + Math.PI / 2) * r, y: points[i].y + Math.sin(angle + Math.PI / 2) * r });
        }
        ctx.beginPath();
        ctx.fillStyle = hexToRgba(tint, opacity);
        ctx.moveTo(upperSide[0].x, upperSide[0].y);
        for (let i = 0; i < upperSide.length - 1; i++) {
            const xc = (upperSide[i].x + upperSide[i+1].x) / 2;
            const yc = (upperSide[i].y + upperSide[i+1].y) / 2;
            ctx.quadraticCurveTo(upperSide[i].x, upperSide[i].y, xc, yc);
        }
        ctx.lineTo(upperSide[upperSide.length-1].x, upperSide[upperSide.length-1].y);
        const last = points[points.length-1];
        const prev = points[points.length-2] || last;
        const endAngle = Math.atan2(last.y - prev.y, last.x - prev.x);
        ctx.arc(last.x, last.y, growth, endAngle - Math.PI/2, endAngle + Math.PI/2);
        ctx.lineTo(lowerSide[lowerSide.length-1].x, lowerSide[lowerSide.length-1].y);
        for (let i = lowerSide.length - 1; i > 0; i--) {
            const xc = (lowerSide[i].x + lowerSide[i-1].x) / 2;
            const yc = (lowerSide[i].y + lowerSide[i-1].y) / 2;
            ctx.quadraticCurveTo(lowerSide[i].x, lowerSide[i].y, xc, yc);
        }
        ctx.closePath();
        ctx.fill();
    }

    function getPerpAngle(i) {
        if (points.length < 2) return 0;
        let pPrev = points[Math.max(0, i - 1)];
        let pNext = points[Math.min(points.length - 1, i + 1)];
        return Math.atan2(pNext.y - pPrev.y, pNext.x - pPrev.x);
    }

    function renderPoints() {
        const pRadius = parseInt(document.getElementById('pointSize').value);
        const tSize = parseInt(document.getElementById('textSize').value);
        const fontSel = document.getElementById('fontFamily').value;
        const fontFam = fontSel === 'custom' ? document.getElementById('customFontName').value : fontSel;
        const hasOutline = document.getElementById('pointOutline').checked;
        const oColor = document.getElementById('outlineColor').value;
        const showMulti = document.getElementById('showMultiUnit').checked;

        points.forEach((p, i) => {
            const mphValue = convertWind(p.wind, currentUnit, 'mph');
            const color = SCHEME.find(s => mphValue >= s.min)?.color || "#666";
            if(i < points.length - 1) {
                ctx.beginPath(); ctx.setLineDash([4, 4]);
                ctx.moveTo(p.x, p.y); ctx.lineTo(points[i+1].x, points[i+1].y);
                ctx.strokeStyle = "rgba(255,255,255,0.25)"; ctx.lineWidth = 1; ctx.stroke();
                ctx.setLineDash([]);
            }
            if (highlightedPointIndex === i) {
                const pulse = (Math.sin(Date.now() / 150) + 1) / 2;
                ctx.beginPath(); ctx.arc(p.x, p.y, pRadius + 5 + (pulse * 5), 0, Math.PI * 2);
                ctx.strokeStyle = "rgba(59, 130, 246, 0.6)"; ctx.lineWidth = 2; ctx.stroke();
            }
            ctx.beginPath(); ctx.arc(p.x, p.y, pRadius, 0, Math.PI*2);
            ctx.fillStyle = color; ctx.fill();
            if (hasOutline) { ctx.strokeStyle = oColor; ctx.lineWidth = 2; ctx.stroke(); }
            
            // Text Label
            ctx.textAlign = "left"; ctx.textBaseline = "middle"; ctx.lineJoin = "round";
            const drawTextWithHalo = (text, x, y, size, weight = "600", alpha = 1) => {
                ctx.font = `${weight} ${size}px "${fontFam}", sans-serif`;
                ctx.strokeStyle = "rgba(0,0,0,0.8)"; ctx.lineWidth = 4; ctx.strokeText(text, x, y);
                ctx.fillStyle = `rgba(255,255,255,${alpha})`; ctx.fillText(text, x, y);
            };
            
            let dateStr = "";
            if(p.date) { const d = p.date.split('-'); if(d.length === 3) dateStr = `${d[1]}/${d[2]}`; }
            let timeStr = p.time ? p.time.split(':')[0] + "z" : "";
            let header = `${p.name} ${dateStr} ${timeStr}`.trim();
            drawTextWithHalo(header, p.x + pRadius + 8, p.y - (tSize/2), tSize, "600", 1);
            
            let windLabel = `${p.wind || 0} ${currentUnit.toUpperCase()}`;
            if(showMulti) {
                let secondary = (currentUnit === 'mph') ? 'KPH' : (currentUnit === 'kph' ? 'KT' : 'MPH');
                const secondaryVal = convertWind(p.wind, currentUnit, secondary.toLowerCase());
                windLabel += ` / ${secondaryVal} ${secondary}`;
            }
            let subLabel = `${windLabel}${p.press ? ' | ' + p.press + 'mb' : ''}`;
            drawTextWithHalo(subLabel, p.x + pRadius + 8, p.y + (tSize/2) + 2, tSize - 1, "500", 0.85);
        });
        if (highlightedPointIndex !== -1) requestAnimationFrame(() => draw());
    }

    function renderLegendToCanvas() {
        const padding = 15; const boxWidth = 110; const boxHeight = (SCHEME.length * 16) + 20;
        const x = canvas.width - boxWidth - padding; const y = canvas.height - boxHeight - padding;
        ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(x, y, boxWidth, boxHeight, 10); else ctx.rect(x, y, boxWidth, boxHeight);
        ctx.fill();
        ctx.font = "bold 9px Inter, sans-serif"; ctx.textAlign = "left"; ctx.textBaseline = "middle";
        SCHEME.forEach((s, i) => {
            const rowY = y + 15 + (i * 16); ctx.fillStyle = s.color; ctx.beginPath(); 
            ctx.arc(x + 15, rowY, 4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = "#aaa"; ctx.fillText(s.label, x + 25, rowY);
        });
    }

    function updateSidebar() {
        const list = document.getElementById('pointList');
        list.innerHTML = '';
        points.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `point-card ${highlightedPointIndex === i ? 'highlighted' : ''}`;
            div.onmousedown = (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    highlightedPointIndex = i; updateSidebar(); draw();
                }
            };

            // Formatting date to MM/DD for display
            let displayDate = "";
            if (p.date) {
                const parts = p.date.split('-');
                if (parts.length === 3) displayDate = `${parts[1]}/${parts[2]}`;
            }

            div.innerHTML = `
                <div class="card-row">
                    <span class="point-id">#${i+1}</span>
                    <select onchange="saveState(); points[${i}].name=this.value; draw();" style="flex:1.5">
                        <option value="">TYPE</option>
                        <option value="HU" ${p.name=='HU'?'selected':''}>HU</option>
                        <option value="TS" ${p.name=='TS'?'selected':''}>TS</option>
                        <option value="TD" ${p.name=='TD'?'selected':''}>TD</option>
                        <option value="PT" ${p.name=='PT'?'selected':''}>PT</option>
                        <option value="EX" ${p.name=='EX'?'selected':''}>EX</option>
                        <option value="SD" ${p.name=='SD'?'selected':''}>SD</option>
                        <option value="RL" ${p.name=='RL'?'selected':''}>RL</option>
                        <option value="POST" ${p.name=='POST'?'selected':''}>POST</option>
                    </select>
                    <input type="number" value="${p.wind === 0 ? '' : p.wind}" placeholder="Wind" oninput="saveState(); points[${i}].wind=parseInt(this.value)||0; draw();" style="flex:1">
                    <input type="number" value="${p.press || ''}" oninput="saveState(); points[${i}].press=this.value; draw();" placeholder="mb" style="flex:1">
                </div>
                <div class="card-row">
                    <div style="flex:1.2; display:flex; flex-direction:column; gap:2px;">
                         <span style="font-size:8px; color:var(--text-dim); text-transform:uppercase;">Date (MM/DD)</span>
                         <input type="text" value="${displayDate}" placeholder="MM/DD" onchange="handleManualDateEntry(${i}, this.value)" style="font-size:11px;">
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column; gap:2px;">
                         <span style="font-size:8px; color:var(--text-dim); text-transform:uppercase;">Time (24h)</span>
                         <input type="time" value="${p.time}" oninput="saveState(); points[${i}].time=this.value; if(${i}===0) cascadeDateTime(); else draw();">
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function handleManualDateEntry(index, val) {
        saveState();
        const parts = val.split('/');
        if (parts.length === 2) {
            const year = new Date().getFullYear();
            points[index].date = `${year}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
        } else if (!val) {
            points[index].date = "";
        }
        if (index === 0) cascadeDateTime();
        else draw();
    }

    const getCoords = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    };

    canvas.addEventListener('mousedown', (e) => {
        const {x, y} = getCoords(e); lastMousePos = {x, y};
        if (e.shiftKey) { isMapDragging = true; return; }
        const hitIndex = points.findIndex(p => Math.hypot(p.x-x, p.y-y) < 20);
        if(hitIndex !== -1) {
            saveState(); draggingPoint = points[hitIndex]; highlightedPointIndex = hitIndex; updateSidebar();
        } else if(e.button !== 2) {
            saveState(); 
            let newDate = ""; 
            let newTime = "18:00";
            
            if (points.length > 0) {
                const last = points[points.length-1];
                const interval = parseFloat(document.getElementById('timeInterval').value) || 6;
                const prevDateObj = new Date(`${last.date || new Date().toISOString().split('T')[0]}T${last.time}:00Z`);
                const nextDateObj = new Date(prevDateObj.getTime() + (interval * 60 * 60 * 1000));
                newDate = nextDateObj.toISOString().split('T')[0];
                newTime = nextDateObj.toISOString().split('T')[1].slice(0,5);
            }
            
            points.push({ x, y, wind: 0, name: "", date: newDate, time: newTime, showLabel: true, press: "" });
            highlightedPointIndex = points.length - 1; updateSidebar(); draw();
        }
    });

    window.addEventListener('mousemove', (e) => {
        const {x, y} = getCoords(e); const dx = x - lastMousePos.x, dy = y - lastMousePos.y;
        if (isMapDragging) {
            const mapX = document.getElementById('mapX'), mapY = document.getElementById('mapY');
            mapX.value = parseInt(mapX.value) + dx; mapY.value = parseInt(mapY.value) + dy; draw();
        } else if(draggingPoint) {
            draggingPoint.x = x; draggingPoint.y = y; draw();
        }
        lastMousePos = {x, y};
    });

    window.addEventListener('mouseup', () => { draggingPoint = null; isMapDragging = false; });

    canvas.addEventListener('wheel', (e) => {
        if (e.shiftKey) {
            e.preventDefault();
            const scaleInput = document.getElementById('mapScale');
            const delta = e.deltaY > 0 ? -12 : 12;
            let newVal = parseInt(scaleInput.value) + delta;
            if (newVal < 100) newVal = 100;
            if (newVal > 1000) newVal = 1000;
            scaleInput.value = newVal;
            draw();
        }
    }, { passive: false });
    
    canvas.oncontextmenu = (e) => {
        e.preventDefault(); saveState(); const {x, y} = getCoords(e);
        points = points.filter(p => Math.hypot(p.x-x, p.y-y) > 20);
        highlightedPointIndex = -1; updateSidebar(); draw();
    };

    function resetPoints() { saveState(); points = []; highlightedPointIndex = -1; updateSidebar(); draw(); }
    function hexToRgba(hex, alpha) {
        let r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    function confirmExport() {
        draw(true); setTimeout(() => {
            const link = document.createElement('a'); link.download = `Storm_Track.png`;
            link.href = canvas.toDataURL('image/png'); link.click(); draw();
        }, 100);
    }
    const leg = document.getElementById('legend');
    SCHEME.forEach(s => { leg.innerHTML += `<div class="leg-item"><div class="dot" style="background:${s.color}"></div>${s.label}</div>`; });
    document.querySelectorAll('#controls input, #controls select').forEach(i => i.addEventListener('input', draw));
</script>
</body>
</html>
