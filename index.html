<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storm Studio | Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #3b82f6;
            --bg: #0a0a0c;
            --panel: rgba(25, 25, 30, 0.95);
            --border: rgba(255, 255, 255, 0.1);
        }
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: #fff;
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }

        /* Minimalist Sidebar */
        .sidebar {
            width: 320px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; backdrop-filter: blur(10px); z-index: 10;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .sidebar-header h1 { font-size: 1.2rem; margin: 0; font-weight: 600; letter-spacing: -0.5px; }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Glassmorphism Controls */
        .control-group { margin-bottom: 25px; }
        label { font-size: 11px; text-transform: uppercase; color: #777; letter-spacing: 1px; display: block; margin-bottom: 10px; }
        
        input[type="range"] { width: 100%; height: 4px; background: #333; border-radius: 2px; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 15px; height: 15px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
            width: 100%; background: #1a1a1f; border: 1px solid var(--border); color: #fff;
            padding: 8px; border-radius: 6px; font-size: 13px; margin-bottom: 8px; box-sizing: border-box;
        }

        .point-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 12px; border-radius: 8px; margin-bottom: 10px; position: relative;
        }
        .point-card:hover { border-color: var(--accent); }
        
        /* Main Canvas Area */
        .canvas-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
        canvas { cursor: crosshair; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* Floating Legend */
        .legend {
            position: absolute; bottom: 20px; right: 20px; background: var(--panel);
            padding: 15px; border-radius: 10px; border: 1px solid var(--border); font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; opacity: 0.8; }
        .color-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }

        button {
            background: var(--accent); color: white; border: none; padding: 10px;
            border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border); margin-top: 10px; }
        
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Storm Studio</h1>
        </div>
        
        <div class="scroll-area">
            <div class="control-group">
                <label>Basemap</label>
                <div class="file-input-wrapper">
                    <button class="btn-outline">Upload Image</button>
                    <input type="file" id="imageLoader" accept="image/*">
                </div>
            </div>

            <div class="control-group">
                <label>Cone Styling</label>
                <div style="display:flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="color" id="coneColor" value="#ffffff" style="width:40px; height:30px; border:none; background:none;">
                    <span style="font-size: 12px;">Tint Color</span>
                </div>
                <label>Spread</label>
                <input type="range" id="coneGrowth" min="10" max="200" value="70">
                <label style="margin-top:10px">Opacity</label>
                <input type="range" id="coneOpacity" min="1" max="10" value="3">
            </div>

            <div class="control-group">
                <label>Points Configuration</label>
                <div id="pointList"></div>
            </div>

            <button class="btn-outline" style="border-color: #ef4444; color: #ef4444;" onclick="resetPoints()">Clear All</button>
            <button class="btn-outline" style="margin-top:10px" onclick="downloadMap()">Export PNG</button>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="stormCanvas" width="1000" height="750"></canvas>
        <div class="legend" id="legend"></div>
    </div>

<script>
    const canvas = document.getElementById('stormCanvas');
    const ctx = canvas.getContext('2d');
    const SCHEME = [
        { label: "Cat 5", min: 157, color: "#A188FC" },
        { label: "Cat 4", min: 130, color: "#FF738A" },
        { label: "Cat 3", min: 111, color: "#FF9E59" },
        { label: "Cat 2", min: 96,  color: "#FFD98C" },
        { label: "Cat 1", min: 74,  color: "#FFFFD9" },
        { label: "TS",    min: 39,  color: "#4DFFFF" },
        { label: "TD",    min: 0,   color: "#6EC1EA" }
    ];

    let points = [];
    let bgImage = null;
    let draggingPoint = null;

    // Load Background
    document.getElementById('imageLoader').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            bgImage = new Image();
            bgImage.onload = draw;
            bgImage.src = f.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    function getStormColor(wind) {
        return SCHEME.find(s => wind >= s.min)?.color || "#CCCCCC";
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (bgImage) ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
        else {
            ctx.fillStyle = "#0f0f12"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
            for(let i=0; i<canvas.height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
        }

        if (points.length < 2) { renderPoints(); return; }

        const growth = parseInt(document.getElementById('coneGrowth').value);
        const opacity = document.getElementById('coneOpacity').value / 10;
        const tint = document.getElementById('coneColor').value;

        // Draw Cone
        ctx.beginPath();
        ctx.fillStyle = hexToRgba(tint, opacity);
        
        // Upper curve
        ctx.moveTo(points[0].x, points[0].y);
        for(let i=0; i < points.length - 1; i++) {
            let r1 = (i/points.length) * growth;
            let r2 = ((i+1)/points.length) * growth;
            // Calculate perpendicular offsets
            let angle = Math.atan2(points[i+1].y - points[i].y, points[i+1].x - points[i].x) - Math.PI/2;
            ctx.lineTo(points[i].x + Math.cos(angle)*r1, points[i].y + Math.sin(angle)*r1);
        }

        // Rounded End Cap
        const last = points[points.length-1];
        const prev = points[points.length-2];
        const endAngle = Math.atan2(last.y - prev.y, last.x - prev.x);
        ctx.arc(last.x, last.y, growth, endAngle - Math.PI/2, endAngle + Math.PI/2);

        // Lower curve back
        for(let i=points.length-1; i >= 0; i--) {
            let r = (i/points.length) * growth;
            let angle = (i === points.length-1) ? endAngle + Math.PI/2 : Math.atan2(points[i+1].y - points[i].y, points[i+1].x - points[i].x) + Math.PI/2;
            ctx.lineTo(points[i].x + Math.cos(angle)*r, points[i].y + Math.sin(angle)*r);
        }

        ctx.closePath();
        ctx.fill();
        ctx.strokeStyle = hexToRgba(tint, 0.5);
        ctx.stroke();

        renderPoints();
    }

    function renderPoints() {
        points.forEach((p, i) => {
            const color = getStormColor(p.wind);
            ctx.beginPath();
            ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();

            if (p.showLabel || p.date || p.time) {
                ctx.fillStyle = "white";
                ctx.font = "600 12px Inter";
                let text = `${p.showLabel ? p.label : ''} ${p.date.split('-').slice(1).join('/')} ${p.time}`.trim();
                ctx.fillText(text, p.x + 12, p.y - 5);
                ctx.font = "400 11px Inter";
                ctx.fillText(`${p.wind} mph`, p.x + 12, p.y + 10);
            }
        });
    }

    function updateSidebar() {
        const container = document.getElementById('pointList');
        container.innerHTML = '';
        points.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'point-card';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px">
                    <span style="font-size:11px; font-weight:600">POINT ${i+1}</span>
                    <input type="checkbox" ${p.showLabel ? 'checked' : ''} onchange="points[${i}].showLabel=this.checked; draw();">
                </div>
                <input type="text" placeholder="Label (e.g. H1)" value="${p.label}" oninput="points[${i}].label=this.value; draw();">
                <div style="display:flex; gap:5px">
                    <input type="date" value="${p.date}" oninput="points[${i}].date=this.value; draw();">
                    <input type="time" value="${p.time}" oninput="points[${i}].time=this.value; draw();">
                </div>
                <input type="number" value="${p.wind}" oninput="points[${i}].wind=this.value; draw();" placeholder="Wind Speed">
            `;
            container.appendChild(div);
        });
    }

    canvas.onmousedown = (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        const hit = points.find(p => Math.hypot(p.x-mx, p.y-my) < 20);
        
        if (hit) draggingPoint = hit;
        else {
            points.push({x: mx, y: my, wind: 65, label: "", date: "", time: "", showLabel: true});
            updateSidebar();
            draw();
        }
    };

    window.onmousemove = (e) => {
        if(draggingPoint) {
            const rect = canvas.getBoundingClientRect();
            draggingPoint.x = e.clientX - rect.left;
            draggingPoint.y = e.clientY - rect.top;
            draw();
        }
    };

    window.onmouseup = () => draggingPoint = null;
    canvas.oncontextmenu = (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        points = points.filter(p => Math.hypot(p.x-mx, p.y-(e.clientY - rect.top)) > 20);
        updateSidebar(); draw();
    };

    function hexToRgba(hex, alpha) {
        let r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function buildLegend() {
        const leg = document.getElementById('legend');
        SCHEME.forEach(s => {
            leg.innerHTML += `<div class="legend-item"><div class="color-dot" style="background:${s.color}"></div>${s.label}</div>`;
        });
    }

    function resetPoints() { points = []; updateSidebar(); draw(); }
    
    function downloadMap() {
        const link = document.createElement('a');
        link.download = 'storm-forecast.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    document.querySelectorAll('input[type=range], input[type=color]').forEach(i => i.oninput = draw);
    buildLegend();
    draw();
</script>
</body>
</html>
